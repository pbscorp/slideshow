<!DOCTYPE html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Question & Answer Slideshow with Sequential Backgrounds</title>
  <link rel="stylesheet" href="css/slideshow.css">

</head>

<body>
  <div id="initSlide" class='background-slde' style="background-image: url('media/default.jpeg');">
    <div class="slide-container" id="slideContainer">
      <div id="slide" class="slide active other-slide "></div>
    </div>
  </div>

  <div id="overlay" class="overlay-text title-slide"></div>

  <button class="nav-button prev" onclick="changeSlide(-1)">❮</button>
  <button id="nextButton" class="nav-button next" onclick="changeSlide(1)">❯</button>
  <button class="start-button mute-button" disabled id="start" onclick="startSlideshow()">open</button>
  <script src="js/escapeHTML.js"></script>

  <div id="customConfirmModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
      <div class="modal-header">
        <h2>⋆✴︎˚｡⋆Congratulations!⋆✴︎˚｡⋆</h2>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to proceed with this action?</p>
      </div>
      <div class="modal-footer">
        <button id="cancelButton" class="btn cancel">Cancel</button>
        <button id="confirmButton" class="btn confirm">Confirm</button>
      </div>
    </div>
  </div>

  <div id="alertOverlayID" class="alertOverlay hidden">
    <div class="alertBox" role="alertdialog" aria-modal="true">
      <p id="alertText"></p>
      <button onclick="closeAlert()">OK</button>
    </div>
  </div>

  <script>

  async function getConfig(folder) {
        //alert ('folder = ' + folder);

        const response = await fetch(folder.trim() + "/config.json?_=" + Date.now());

      if (!response.ok) {
            console.log("Cannot load " + folder + " config file");
      }
      try {
        const config = await response.json();
        //alert(1.1);	
        if (!config || config.length === 0) {
          alert("No config found");
        }
       // console.log(' config file folder ' + folder + ' dateActive = ' + config.dateActive);
       /*
        form_configTitle.value = config.title;
        form_configDescription.value = config.description;
        form_configTheme.value = config.theme;
        form_configDate.value = config.dateActive;
        form_configWebsite.value = config.website;
        form_configAbout.value = config.about;
        if (config.dateActive.trim()) {
          form_configPublic.checked = true;
          form_configDate.style.display = 'inline';
        } else {
          form_configDate.style.display = 'none';
        }
          */ 
      console.log('config; ' + config);
      return config;
      } catch (error) {
        alert(' error get config' + folder + ' config file ' + error);
        return;
      }
    }
    function showAlert(message) {
      document.getElementById("alertText").innerHTML = message;
      document.getElementById("alertOverlayID").classList.remove("hidden");
    }
    function closeAlert() {
      document.getElementById("alertOverlayID").classList.add("hidden");
    }

  </script>
  <script>
    //showAlert('Hello there');
    let currentSlide = 1;
    let isMuted = false;
    let slides = [];
    let audioElements = []; // Array to store audio elements
    let videoElements = []; // Array to store audio elements
    let isStarted = false; // Flag to track if slideshow has started
    let isMedia = false;
    let isAudio = false;
    let hasImage = false;
    var ssData = '';
    var playlist = [];
    let muteButton = document.querySelector('.start-button');
    const rawData = sessionStorage.getItem("slideshowData");
    if (rawData) {
      ssData = JSON.parse(rawData);
    } else {
      alert("No slideshow data found in sessionStorage.");
    }
    var myConfig = {};
    var relatedConfig = {};
    const projName = ssData.projName;
    const txtData = unescapeHTML(ssData.txtHTMLdata);

    var relatedShow = "";
    var relatedShowTitle = "";
    async function loadConfigs() {
      myConfig = await getConfig(projName);
      console.log('myConfig: ', myConfig);
      if (myConfig.website && myConfig.website.length) {
        relatedConfig = await getConfig(myConfig.website);
        console.log('relatedConfig: ', relatedConfig);
      }
    }

    loadConfigs();

    //alert ('projName = ' + projName);
    var g_audioFailed = false;
    const text = txtData.trim().split('\n');
  </script>
  <script>
    setMuteButton = function () {
      //const muteButton = document.querySelector('.mute-toggle');
      muteButton.classList.remove('mute');
      muteButton.classList.remove('unmute');
      muteButton.classList.add(!isMuted ? 'unmute' : 'mute');
      muteButton.textContent = isMuted ? 'Unmute/Play' : 'Mute/Pause';
    }	
  </script>
  <script>
    toggleMute = function () {
      isMuted = !isMuted;
      setMuteButton();
      if (isMedia) {
        if (isMuted) {
          audioElements[currentSlide].pause();
          if (isVideo) {
            muteVideo();
          }
        } else {
          audioElements[currentSlide].play();
          audioElements[currentSlide].onended = () => { changeSlide(1); };
          if (isVideo) {
            unMuteVideo();
          }
        }
      };
    };

  </script>

  <script>
    function customConfirm(message) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customConfirmModal');
        const confirmBtn = document.getElementById('confirmButton');
        const cancelBtn = document.getElementById('cancelButton');
        const modalMessage = modal.querySelector('.modal-body p');
        modalMessage.textContent = message;
        modal.classList.add('show-modal');
        const handleConfirm = () => {
          closeModal();
          resolve(true);
        };

        const handleCancel = () => {
          closeModal();
          resolve(false);
        };

        const closeModal = () => {
          modal.classList.remove('show-modal');
          confirmBtn.removeEventListener('click', handleConfirm);
          cancelBtn.removeEventListener('click', handleCancel);
        };

        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);

        // Close if user clicks outside the modal
        window.onclick = function (event) {
          if (event.target == modal) {
            handleCancel();
          }
        };
      });
    }

    // Example usage:
    
    async function tryAgain(msg, folder) {
      const isConfirmed = await customConfirm(msg);
          console.log("test confirm message " + msg);
          console.log("test confirm folder " + folder);

      if (isConfirmed) {
        	// const url = `../Jokes/index.html`;
        	const url = `../${folder}/index.html`;
		    window.location.href = url;
      } else {
        //history.go(-2);
      }
    }
    console.log("test confirm message");
  //testConfirm("Are you really sure you want to delete this item?");
  </script>

  <script>
    function startSlideshow() {
      isStarted = true;
      document.querySelector('.start-button').style.display = 'none'; // Hide start button.
      document.querySelector('.start-button').textContent = 'Mute/Pause';
      document.querySelector('.start-button').classList.add('mute-toggle');
      document.querySelector('.start-button').onclick = toggleMute;
      document.querySelector('.next').style.display = 'block';
      document.querySelector('.prev').style.display = 'block';
      if (myConfig.website && myConfig.website.length) {
        relatedShow = myConfig.website.trim();
        relatedShowTitle = relatedConfig.title.trim();
      }
    //alert ('relatedShow = ' + relatedShow);
    //alert ('relatedShowTitle = ' + relatedShowTitle);
      updateSlides(1); // Trigger first slide with audio
    }
  </script>

  <script>

    const aryMediaFiles = ssData.aryMediaFiles;
    const aryMediaExt = ssData.aryMediaExt;

    const element = document.getElementById('initSlide');
    const style = window.getComputedStyle(element);
    let defaultImage = style.backgroundImage;
    defaultImage = defaultImage.slice(4, -1);
    defaultImage = defaultImage.replace(/["']/g, "");

    function getMediaFile(myBaseFile, myMedia) {
      const baseFile = `${projName}/media/${myBaseFile}`;
      console.log(' myMedia ' + myMedia + ' baseFile ' + baseFile);
      if (!Array.isArray(aryMediaFiles[myMedia]) || !Array.isArray(aryMediaFiles[myMedia][0])) {
        return false;
      }
      const index = aryMediaFiles[myMedia][0].indexOf(baseFile);
      if (index === -1) {
        return false;
      }
      const source = myBaseFile + aryMediaFiles[`${myMedia}`][1][index];
      const result = aryMediaFiles[`${myMedia}`][0][index] + aryMediaFiles[`${myMedia}`][1][index];
      console.log(' result = ' + result);

      if (myMedia == "video") {
        playlist.push(result);
      }
      return result;
    }
  </script>
  <script>
    function setOverlayText(txt) {
      if (txt.length) {
        document.getElementById("overlay").innerHTML = `<p>${txt}</p>`;
      } else {
        document.getElementById("overlay").innerHTML = ``;
      };
    }

    function getStringAfterFirstColon(inputString) {
      const firstColonIndex = inputString.indexOf(':');
      if (firstColonIndex === -1) {
        // If no colon is found, return the original string or an empty string, depending on requirements.
        // For this example, it returns the original string.
        return inputString;
      } else {
        // Return the substring starting from the character after the first colon.
        return inputString.slice(firstColonIndex + 1);
      }

    }
  </script>
  <script>
    newDefault = getMediaFile("default", "image");
    //alert("test default = " + newDefault);
    if (newDefault && newDefault != "false") {
      defaultImage = newDefault;
      document.getElementById('initSlide').style.backgroundImage = `url('${defaultImage}')`;
    }

    const firstLine = text[0];

    const titleType = firstLine.split(':')[0];
    if (titleType == 'TITLE') {
      const titleText = getStringAfterFirstColon(firstLine);
      //alert(`<p>${sanitizeHTML(titleText)}</p>`);
      //document.getElementById('slide').innerHTML += `<p>${sanitizeHTML(titleText)}</p>`;
      setOverlayText(`${titleText}</p>`);
    }


  </script>

  <script>
    const emailRegex = /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi;
    //alert('textlength = ' + text.length);
    var questionContent = "";
    var questionnNmber = "";
    var correctAnswer = "";
    var correctAnswerList = '';
    var correctAnswerCtr = 0;
    var inCorrectAnswerCtr = 0;
    var multiChoiceCtr = 0;
    var resultBacground = getMediaFile('result', 'image');
    var resultAudio= getMediaFile('result', 'sound');
    var resultVideo = getMediaFile('result', 'video');
    var multiQuestionImage="";
 // from https://from pixabay.com/sound-effects/search/timer/?content_type=authentic&theme=film+%26+special+effects   

    var thirtySecTicking = "media/thirtySecTicking.m4a";
    var threeSecQuite = "media/threeSecQuite.m4a";
    var nineSecQuite = "media/nineSecQuite.m4a";
    var fifteenSecQuite = "media/fifteenSecQuite.m4a";

    slides.push({
      type: 'results',
      content: "",
      background: resultBacground,
      audioSrc: resultAudio,
      videoSrc: resultVideo
    })
    text.forEach(text => {

      const textline = sanitizeHTML(text.trim());
      //const line = text.trim();
      const line = textline.replace(emailRegex, email => {
        return `<a href="mailto:${email}">${email}</a>`;
      })
      //alert(line);
      // Match Q1:, A1:, Q2:, A2:, etc.
      // Match Q1:, A1:, Q2:, A2:, etc.
      const questionMatch = line.match(/^Q(\d+):(.+)/) || line.match(/^QM(\d+):(.+)/);
      const answerMatch = line.match(/^A(\d+):(.+)/) || line.match(/^AM(\d+):(.+)/);
      const multQuestionMatch = line.match(/^QM(\d+):(.+)/);
      const multChoiceMatch = line.match(/^CM(\d+):(.+)/);
      const multAnswerMatch = line.match(/^AM(\d+):(.+)/);
      const otherMatch = line.match(/^S(\d+):(.+)/);
      const otherType = line.split(':')[0];
      const slideKey = line.split(':')[0];
      var otherContent = getStringAfterFirstColon(line);

      if (questionMatch) {
        questionContent = otherContent;
        questionnNmber = slideKey;
        correctAnswer = "";
      }
      if (multAnswerMatch) {
        correctAnswer = questionnNmber + ':' + otherContent.split(',')[0];
        correctAnswerList += correctAnswer.replace(/\s/g, '') + '/';
        //console.log('correctAnswerList ' + correctAnswerList);
      }
      if (multChoiceMatch) {
        multiChoiceCtr++;
        var li = `<li onclick="checkAnswer('${questionnNmber}', this.innerHTML)">`;
        var choiceContent = questionContent + '<ul>';
        var answerArray = otherContent.split(',');
        answerArray.forEach(answer => {
          choiceContent += li + answer + '</li>';
        });
        choiceContent += '</ul';
        otherContent = choiceContent;
        //console.log('choiceContent ' + choiceContent);
      }
      //console.log('otherContent ' + otherContent);
      // alert('otherType = ' + otherType);
      var videoFilePath = getMediaFile(otherType, "video");
      var imageFilePath = getMediaFile(otherType, "image");
      var soundFilePath = getMediaFile(otherType, "sound");
      console.log(slideKey + '   XXXXXXXXsoundFilePath >>' + soundFilePath + ' = ' + (soundFilePath));
      if (!soundFilePath) {
        console.log(soundFilePath + " not found");
      }

      if (multQuestionMatch) {
        multiQuestionImage = `${imageFilePath}`;
        if (soundFilePath) {
          soundFilePath = soundFilePath;
          sound2FilePath = threeSecQuite;
        } else {
          soundFilePath = threeSecQuite;
          sound2FilePath = '';
        }
        slides.push({
          type: 'multiQuestion',
          content: otherContent.trim(),
          background: `${imageFilePath}`,
          audioSrc: `${soundFilePath}`,
          audioSrc2: `${sound2FilePath}`,
          videoSrc: `${videoFilePath}`
        });
      } else if (questionMatch) {
        slides.push({
          type: 'question',
          content: otherContent.trim(),
          background: `${imageFilePath}`,
          audioSrc: `${soundFilePath}`,
          videoSrc: `${videoFilePath}`
        });
      } else if (answerMatch) {
        if (soundFilePath) {
          soundFilePath = soundFilePath;
          sound2FilePath = threeSecQuite;
        } else {
          soundFilePath = nineSecQuite;
          sound2FilePath = "";
        }
        //console.log('=============soundFilePath >>' + soundFilePath + ' = ' + (soundFilePath));
        //console.log('=============soundFilePath >>' + sound2FilePath + ' = ' + (sound2FilePath));
        slides.push({
          type: 'answer',
          content: otherContent.trim(),
          background: `${imageFilePath}`,
          audioSrc: `${soundFilePath}`,
          audioSrc2: `${sound2FilePath}`,
          videoSrc: `${videoFilePath}`
        });
      } else if (choiceContent) {
        if (!imageFilePath ||  imageFilePath == 'false') {
           imageFilePath = multiQuestionImage;
        }
        multiQuestionImage = '';
        if (soundFilePath) {
          soundFilePath = soundFilePath;
          sound2FilePath = thirtySecTicking;
        } else {
          soundFilePath = thirtySecTicking;
          sound2FilePath = "";
        }
        slides.push({
          type: 'multi-choice',
          content: otherContent.trim(),
          background: `${imageFilePath}`,
          audioSrc: `${soundFilePath}`,
          audioSrc2: `${sound2FilePath}`,
          videoSrc: `${videoFilePath}`
        });
      } else if (otherType != "TITLE") {
        slides.push({
          type: 'other',
          content: otherContent.trim(),
          background: `${imageFilePath}`,
          audioSrc: `${soundFilePath}`,
          audioSrc2: "",
          videoSrc: `${videoFilePath}`
        });
      }
    });
    document.querySelector('.start-button').disabled = false;

    //showAlert('Hello there we can start now');

    //alert("hey");
  </script>

  <script>
    var currentAnswerCorrect;
    var currentAnswerIncorrect;

	function inCorrectAnswer() {
        currentAnswerCorrect = false;
        currentAnswerIncorrect = true;
        playIncorrectSoundPureJS();
        inCorrectAnswerCtr++;
	}
    function checkAnswer(questionnNmber, myAnswer) {
      answer = questionnNmber + ':' + myAnswer.replace(/\s/g, '').substring(0, 10);
      console.log('********************* answer = ' + answer);
      let index = correctAnswerList.indexOf(answer);
      if (index == -1) {
        //alert('incorrect');
       inCorrectAnswer();
      } else {
        if (currentAnswerIncorrect != true) {
          currentAnswerCorrect = true;
          playCorrectSoundPureJS();
          correctAnswerCtr++;
        }
        changeSlide(1);
      }
    }

    function playCorrectSoundPureJS() {
      const audioUrl = 'media/correct-answer-buzzer.wav';
      const audio = new Audio(audioUrl);
      audio.play();
    }
    function playIncorrectSoundPureJS() {
      const audioUrl = 'media/wrong-answer-buzzer.mp3';
      const audio = new Audio(audioUrl);
      audio.play();
    }
  </script>

  <script>
    //       alert("hello function set bg image");

    function setBackgroundImage(el, url) {
      const img = new Image();
      img.onload = function () {
        //alert("Background image loaded:" + url);
        el.style.backgroundImage = `url('${url}')`;
      };
      img.onerror = function () {
        //alert("Failed to load the background image:" + url);
        el.style.backgroundImage = `url(${defaultImage}`;
      };
      img.src = url;
    }


    function showMultichoiceResults() {
      var message = correctAnswerCtr + ' Correct out of ' + multiChoiceCtr + ' Questions ';
      if (inCorrectAnswerCtr > 0) {
        message += ', ' + inCorrectAnswerCtr + ' Incorrect ';
      }
      var score = (correctAnswerCtr / multiChoiceCtr) * 100;
      message += score.toFixed(2) + '%';

      var audioUrl = 'media/correct-answer-buzzer.wav';
      if (score > 99) {
        audioUrl = 'media/excellent.m4a';
        scoreLevel = "Excellent";
      } else if (score > 84) {
        audioUrl = 'media/amazing.m4a';
        scoreLevel = "Amazing";
      } else if (score > 50) {
        audioUrl = 'media/surprising.m4a';
        scoreLevel = "Surprising";
      } else if (score > 25) {
        audioUrl = 'media/bewildering.m4a';
        scoreLevel = "bewildering";
      } else if (score > 10) {
        audioUrl = 'media/notgood.m4a';
        scoreLevel = "not good";
      } else if (score > 5) {
        audioUrl = 'media/poor.m4a';
        scoreLevel = "needs work";
      } else {
        audioUrl = 'media/failed.m4a';
        scoreLevel = "try again";
      }
      const audio = new Audio(audioUrl);
      message += ` ${scoreLevel},`;
      audio.play();
    
       if (score > 90 && relatedShow && relatedShow.length) {
        message += `\n would you like to try  ${relatedShowTitle}?`;
        //tryAgain('"' + message + '", "' + relatedShow + '"'); 
        tryAgain(message, relatedShow); 

       } else {
       //message += '</br> Try again?';
        showAlert(message);
       }
      //

      inCorrectAnswerCtr = 0;
      correctAnswerCtr = 0;
    }
  </script>

  <script src="js/updateSlides.js"></script>

  <script>
    function changeSlide(direction) {
      if (isStarted) {
        if (isVideo) {
          unMuteVideo();
        }
        const prevSlide = currentSlide;
        currentSlide += direction;
        if (currentSlide < 0) {
          currentSlide = slides.length - 1;
        } else if (currentSlide >= slides.length) {
          currentSlide = 0;
        }
        updateSlides(currentSlide);
        if (audioElements[prevSlide]) {
          audioElements[prevSlide].pause();
          audioElements[prevSlide].currentTime = 0;
        }
      }
    }
    document.addEventListener('keydown', (event) => {
      if (event.key === 'ArrowLeft') {
        changeSlide(-1);
      } else if (event.key === 'ArrowRight') {
        changeSlide(1);
      }
    });
  </script>
</body>

</html>