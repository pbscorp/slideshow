<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Voice Recorder</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
        }

        button {
            padding: 10px 20px;
            display: inline-block;
            font-size: 18px;
            background-color: #007bff;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
    #close-button {
        position: absolute;
        top: 10px;   /* Adjust these values for desired spacing */
        right: 10px; /* Adjust these values for desired spacing */
        
        /* Optional styling for the button appearance
        background-color: red;
        color: white;
        border: none;
        border-radius: 50%; /* Makes it a circle 
        cursor: pointer;
        font-size: 20px;
        line-height: 1;
        padding: 5px 8px; /* Adjust padding as needed */
    }
    #downloadLink {
            display: block;
            margin-top: 15px;
            font-size: 18px;
        }
    </style>
</head>
<body>

    <h2>Voice Recorder</h2>
    <button id="recordBtn" style="display:inline">üéôÔ∏è Start </button>
    <button id="playBtn" style="display:none" disabled>‚ñ∂Ô∏è Play </button>
    <button id="uploadBtn" style="display:none" disabled>‚¨ÜÔ∏è Upload </button>

    <button id="close-button"   onclick="window.close()">‚ùå cancel</button>

    <a id="downloadLink" style="display:none">‚¨áÔ∏è Download Recording</a>

    <audio id="audioPlayer" controls style="display:none; margin-top:20px;"></audio>

    <script>
   		const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
		var folder = urlParams.get('folder');

        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        let isRecording = false;

        document.getElementById("recordBtn").addEventListener("click", toggleRecording);
        document.getElementById("playBtn").addEventListener("click", playRecording);
        document.getElementById("uploadBtn").addEventListener("click", uploadRecording);

        async function toggleRecording() {
            const recordBtn = document.getElementById("recordBtn");
            const playBtn = document.getElementById("playBtn");
            const uploadBtn = document.getElementById("uploadBtn");

            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                    const mimeType = getSupportedMimeType();
                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = saveRecording;

                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.textContent = "üõë Stop Recording";
                    playBtn.style.display="none";
                    uploadBtn.style.display="none";
                } catch (err) {
                    alert("Microphone permission denied or unsupported browser.");
                    console.error(err);
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.textContent = "üéôÔ∏è Start Recording";
            }
        }

        function saveRecording() {
            audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
            const url = URL.createObjectURL(audioBlob);
            const playBtn = document.getElementById("playBtn");
            const uploadBtn = document.getElementById("uploadBtn");
            const closeBtn = document.getElementById("closeBtn");
            const recordBtn = document.getElementById("recordBtn");

            const download = document.getElementById("downloadLink");
            download.href = url;

            const ext = mediaRecorder.mimeType.includes("mp4") || mediaRecorder.mimeType.includes("aac")
                ? "m4a"
                : "webm";

            download.download = "recording." + ext;
            download.textContent = "‚¨áÔ∏è Download Recording (" + ext + ")";
            //download.style.display = "block";
            playBtn.style.display="inline";
            uploadBtn.style.display="inline";

            playBtn.disabled = false;
            uploadBtn.disabled = false;

            const audioPlayer = document.getElementById("audioPlayer");
            audioPlayer.src = url;
        }

        function playRecording() {
            const audioPlayer = document.getElementById("audioPlayer");
            const playBtn = document.getElementById("playBtn");
            const uploadBtn = document.getElementById("uploadBtn");
            const closeBtn = document.getElementById("closeBtn");
            audioPlayer.style.display = "block";

            audioPlayer.play();
            audioPlayer.onended = () => {
				audioPlayer.style.display = "none";
            }
            playBtn.style.display="inline";
            uploadBtn.style.display="inline";

            playBtn.disabled = false;
            uploadBtn.disabled = false;         
        }

        function uploadRecording() {
            const formData = new FormData();
            formData.append("audioFile", audioBlob, "recording_audio.opus");
            fetch(`uploadRecording.php?folder=${folder}`, {
                method: "POST",
                body: formData
            })
                .then(res => res.text())
                .then(response => {
                    console.log("Upload response: " + response);
                    if (window.opener) {
                        window.opener.responseFromPopup(response); // Call a function in the parent
                       // window.opener.textFromPopup(response); // Call a variable in the parent
                        console.log('Window.opener ' + window.opener);
                        window.close(); // Close the popup
                    };
                })
                .catch(err => {
                    alert("Upload failed.");
                    console.error(err);
                });
        }

        function getSupportedMimeType() {
            const types = [
                "audio/mp4",
                "audio/aac",
                "audio/webm",
                "audio/webm;codecs=opus",
                "audio/ogg"
            ];
            for (const t of types) {
                if (MediaRecorder.isTypeSupported(t)) return t;
            }
            return "";
        }
    </script>

</body>

</html>